<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
	<title>Dashboard | FakeBookMini</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="./css/styles.css" rel="stylesheet">
    <script>
    	var href = window.location.href;
    	var requestedPath = href.substr(href.lastIndexOf('/')+1);
    	var isHTML = (requestedPath.lastIndexOf('.'));
    	
    	if(isHTML != -1){
    		window.location = "./"+requestedPath.substr(0, requestedPath.lastIndexOf('.'));
    	}
    </script>
    <style>
    	#searchResults{
			box-shadow: 1px 1px 2px lightgrey, -1px -1px 2px lightgrey;
			position: fixed;
			right: 0;
			padding: 0.5rem 1rem !important;
			border-radius: 0.5rem;
			margin: 0.5rem;
			width: 33% !important;
			background: #ffffff;
		}
		
		#searchResults.active{
			z-index: 101;
		}
		
		.overlay{
			position: fixed;
			height: 100%;
			width: 100%;
			top: 0;
			left: 0;
			z-index: -1;
			opacity: 0;
			background: rgba(0, 0, 0, 0.3);
			transition-duration: 0.3s;
		}
		
		.overlay.active{
			z-index: 100;
			opacity: 1;
		}
		
		.search-result-item > .action > .btn > i{
			color: #2196f3;
		}
		
		.search-result-item > .action > .btn.disabled > i{
			color: lightgrey;
		}
		
		.btn:hover{
			background: #2196f3 !important;
		}
		
		.btn:hover > i{
			color: white !important;
		}
		
		.search-result-item.first{
			border: 1px solid lightgrey;
		}
		
		.search-result-item{
			border: 1px solid lightgrey;
			border-top: none;
		}
		
    	
    </style>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js""></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
   
</head>
<body>

<!-- Header -->
<nav class="blue">
    <div class="nav-wrapper">
      <a href="./" class="brand-logo"> &nbsp; &nbsp; FakeBook.<small><small>mini</small></small></a>
      
      <ul id="nav-mobile" class="right hide-on-med-and-down">
      	<li>
      		<div class="input-field col s6">
	          <i class="material-icons prefix" style="color: white;">search</i>
	          <input id="search" onkeyup="search()" type="text" style="border-color: white; color: white;">
	          <label for="search">Search</label>
	        </div>
	        
	        <div class="black-text hide" id="searchResults">
	        	Please wait..
	        </div>
      	</li>
        <li>
        	
			<form action="./logout" name="logout_form" method="POST">
				<input type="submit" name="logout" value="logout" class="btn btn-flat blue white-text">
			</form>
		</li>
      </ul>
    </div>
 </nav>
<!--  /Header  -->  

<!-- Overlay -->
	<div class="overlay">
	</div>
<!-- /Overlay -->


<!-- Preloader -->
	<div class="preloader-hidden center hide">
		<div class="preloader-wrapper small active">
	    <div class="spinner-layer spinner-green-only">
	      <div class="circle-clipper left">
	        <div class="circle"></div>
	      </div><div class="gap-patch">
	        <div class="circle"></div>
	      </div><div class="circle-clipper right">
	        <div class="circle"></div>
	      </div>
	    </div>
	  </div>
	</div>
<!-- /Preloader -->

<script src="./js/scripts.js"></script>
<script>
	M.AutoInit();
	var timeout = null;
	
	
	$(".overlay").click(function(){
		$(".overlay").removeClass('active');
		$("#searchResults").addClass("hide").removeClass('active').html("");
	});
	
	function delayAndCall(func, delay){
		setTimeout(func, delay);
	}
	
	function search(){
		clearTimeout(timeout);
		$(".overlay").addClass('active');
		$("#searchResults").removeClass("hide").addClass('active').html($(".preloader-hidden").clone().removeClass("preloader-hidden hide"));
		
		timeout = setTimeout(function(){
			var q = $("#search").val();
			
			if(q.length <= 0){
				$("#searchResults").html("<div class='center'>No results found!</div>");
			}
			else{
				$.ajax({
					url: './search',
					type: "POST",
					data: { q: q},
					success: function(response){
						if(response.length <= 0)
							$("#searchResults").html("<div class='center'>No results found!</div>");
						else
							$("#searchResults").html(response);
					},
					error: function(err){
						M.toast({html: err.statusText});
					}
				});
			}
		}, 500);
	}
	
	function addFriend(user_id, btn_id){
		
		$("#btn"+btn_id).addClass('disabled');
		
		setTimeout(function(){
			$.ajax({
				url: './addFriend',
				type: 'POST',
				data: { user_id: user_id },
				success: function(response){
					if(response == ""){
						//$("#btn"+btn_id+" i").html('done');
						$("#btn"+btn_id).attr("href", "javascript:cancelRequest('"+user_id+"', '"+btn_id+"')").removeClass('disabled');
						$("#btn"+btn_id+" i").html('close');
					}
					else{
						$("#btn"+btn_id).removeClass('disabled');
						M.toast({html: response});
					}
				},
				error: function(err){
					console.log(err);
				}
			});
		}, 2000);
	}
	
	function cancelRequest(user_id, btn_id){
		
		$("#btn"+btn_id).addClass('disabled');
		
		setTimeout(function(){
			$.ajax({
				url: './cancelRequest',
				type: 'POST',
				data: { user_id: user_id },
				success: function(response){
					if(response == ""){
						$("#btn"+btn_id).attr("href", "javascript:addFriend('"+user_id+"', '"+btn_id+"')").removeClass('disabled');
						$("#btn"+btn_id+" i").html('person_add');
					}
					else{
						$("#btn"+btn_id).removeClass('disabled');
						M.toast({html: response});
					}
				},
				error: function(err){
					console.log(err);
				}
			});
		}, 2000);
	}
	
	function unfriend(user_id, btn_id){
		
		$("#btn"+btn_id).addClass('disabled');
		
		setTimeout(function(){
			$.ajax({
				url: './unfriend',
				type: 'POST',
				data: { user_id: user_id },
				success: function(response){
					if(response == ""){
						$("#btn"+btn_id).attr("href", "javascript:addFriend('"+user_id+"', '"+btn_id+"')").removeClass('disabled');
						$("#btn"+btn_id+" i").html('person_add');
					}
					else{
						$("#btn"+btn_id).removeClass('disabled');
						M.toast({html: response});
					}
				},
				error: function(err){
					console.log(err);
				}
			});
		}, 2000);
	}
	
	function confirmRequest(user_id, btn_id){
		
		$("#btn"+btn_id).addClass('disabled');
		
		setTimeout(function(){
			$.ajax({
				url: './confirmRequest',
				type: 'POST',
				data: { user_id: user_id },
				success: function(response){
					if(response == ""){
						$("#btn"+btn_id).attr("href", "javascript:unfriend('"+user_id+"', '"+btn_id+"')").removeClass('disabled');
						$("#btn"+btn_id+" i").html('remove_circle_outline');
					}
					else{
						$("#btn"+btn_id).removeClass('disabled');
						M.toast({html: response});
					}
				},
				error: function(err){
					console.log(err);
				}
			});
		}, 2000);
	}
</script>
</body>
</html>